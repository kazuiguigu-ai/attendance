<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å‹¤æ€ ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ </title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <link rel="manifest" href="manifest.json">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Hiragino Sans', 'Hiragino Kaku Gothic ProN', sans-serif;
            background: linear-gradient(135deg, #1E2761 0%, #0D1B3E 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .header {
            background: white;
            border-radius: 12px;
            padding: 24px 32px;
            margin-bottom: 24px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .header h1 {
            color: #1E2761;
            font-size: 28px;
            margin-bottom: 8px;
        }

        .header .user-info {
            color: #64748B;
            font-size: 14px;
        }

        .clock-section {
            background: white;
            border-radius: 12px;
            padding: 32px;
            margin-bottom: 24px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .current-time {
            text-align: center;
            margin-bottom: 24px;
        }

        .current-time .date {
            color: #64748B;
            font-size: 16px;
            margin-bottom: 8px;
        }

        .current-time .time {
            color: #1E2761;
            font-size: 48px;
            font-weight: 700;
            font-variant-numeric: tabular-nums;
        }

        .clock-buttons {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 16px;
            margin-bottom: 24px;
        }

        .clock-btn {
            padding: 20px;
            border: none;
            border-radius: 8px;
            font-size: 18px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            color: white;
        }

        .clock-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .clock-btn.start {
            background: #10B981;
        }

        .clock-btn.start:hover:not(:disabled) {
            background: #059669;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
        }

        .clock-btn.end {
            background: #EF4444;
        }

        .clock-btn.end:hover:not(:disabled) {
            background: #DC2626;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(239, 68, 68, 0.3);
        }

        .clock-btn.break-start {
            background: #F59E0B;
        }

        .clock-btn.break-start:hover:not(:disabled) {
            background: #D97706;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(245, 158, 11, 0.3);
        }

        .clock-btn.break-end {
            background: #0891B2;
        }

        .clock-btn.break-end:hover:not(:disabled) {
            background: #0E7490;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(8, 145, 178, 0.3);
        }

        .status-display {
            background: #F1F5F9;
            border-radius: 8px;
            padding: 16px;
            text-align: center;
        }

        .status-display .label {
            color: #64748B;
            font-size: 14px;
            margin-bottom: 4px;
        }

        .status-display .value {
            color: #1E2761;
            font-size: 20px;
            font-weight: 600;
        }

        .status-badge {
            display: inline-block;
            padding: 6px 16px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 600;
            margin-top: 8px;
        }

        .status-badge.working {
            background: #DCFCE7;
            color: #166534;
        }

        .status-badge.break {
            background: #FEF3C7;
            color: #92400E;
        }

        .status-badge.off {
            background: #F1F5F9;
            color: #475569;
        }

        .grid-2 {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 24px;
            margin-bottom: 24px;
        }

        .card {
            background: white;
            border-radius: 12px;
            padding: 24px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .card h2 {
            color: #1E2761;
            font-size: 20px;
            margin-bottom: 16px;
            padding-bottom: 12px;
            border-bottom: 2px solid #E2E8F0;
        }

        .stat-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 16px;
        }

        .stat-item {
            background: #F8FAFC;
            padding: 16px;
            border-radius: 8px;
            border-left: 4px solid #0891B2;
        }

        .stat-item .label {
            color: #64748B;
            font-size: 13px;
            margin-bottom: 4px;
        }

        .stat-item .value {
            color: #1E2761;
            font-size: 24px;
            font-weight: 700;
        }

        .stat-item .unit {
            color: #64748B;
            font-size: 14px;
            margin-left: 4px;
        }

        .record-list {
            max-height: 400px;
            overflow-y: auto;
        }

        .record-item {
            padding: 12px 0;
            border-bottom: 1px solid #E2E8F0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .record-item:last-child {
            border-bottom: none;
        }

        .record-date {
            color: #1E2761;
            font-weight: 600;
            font-size: 14px;
        }

        .record-details {
            display: flex;
            gap: 16px;
            font-size: 13px;
            color: #64748B;
        }

        .record-time {
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .record-total {
            color: #0891B2;
            font-weight: 600;
        }

        .warning {
            background: #FEF3C7;
            border-left: 4px solid #F59E0B;
            padding: 12px 16px;
            border-radius: 8px;
            margin-top: 16px;
        }

        .warning-text {
            color: #92400E;
            font-size: 14px;
        }

        .tabs {
            display: flex;
            gap: 8px;
            margin-bottom: 16px;
            border-bottom: 2px solid #E2E8F0;
        }

        .tab {
            padding: 12px 24px;
            background: none;
            border: none;
            font-size: 15px;
            font-weight: 600;
            color: #64748B;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            transition: all 0.2s;
        }

        .tab.active {
            color: #1E2761;
            border-bottom-color: #0891B2;
        }

        .tab:hover {
            color: #1E2761;
        }

        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: #94A3B8;
        }

        @media (max-width: 768px) {
            .grid-2 {
                grid-template-columns: 1fr;
            }

            .clock-buttons {
                grid-template-columns: 1fr;
            }

            .stat-grid {
                grid-template-columns: 1fr;
            }

            .current-time .time {
                font-size: 36px;
            }
        }

        .manual-entry {
            background: #F8FAFC;
            padding: 16px;
            border-radius: 8px;
            margin-top: 16px;
        }

        .manual-entry h3 {
            color: #1E2761;
            font-size: 16px;
            margin-bottom: 12px;
        }

        .form-group {
            margin-bottom: 12px;
        }

        .form-group label {
            display: block;
            color: #64748B;
            font-size: 13px;
            margin-bottom: 4px;
        }

        .form-group input {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #CBD5E1;
            border-radius: 6px;
            font-size: 14px;
        }

        .form-group input:focus {
            outline: none;
            border-color: #0891B2;
        }

        .btn-submit {
            width: 100%;
            padding: 10px;
            background: #0891B2;
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-submit:hover {
            background: #0E7490;
        }

        .data-management {
            background: #F8FAFC;
            border-radius: 8px;
            padding: 16px;
            margin-top: 16px;
        }

        .data-management h3 {
            color: #1E2761;
            font-size: 16px;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .data-buttons {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            margin-bottom: 12px;
        }

        .export-buttons {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
        }

        .data-btn {
            padding: 10px 16px;
            border: 1px solid #CBD5E1;
            background: white;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
        }

        .data-btn:hover {
            background: #F1F5F9;
            border-color: #0891B2;
            color: #0891B2;
        }

        .data-btn.export {
            color: #0891B2;
        }

        .data-btn.import {
            color: #10B981;
        }

        .data-btn.clear {
            color: #EF4444;
        }

        .data-btn.clear:hover {
            background: #FEE2E2;
            border-color: #EF4444;
        }

        .storage-info {
            margin-top: 12px;
            padding: 12px;
            background: white;
            border-radius: 6px;
            font-size: 13px;
            color: #64748B;
        }

        .storage-info strong {
            color: #1E2761;
        }

        input[type="file"] {
            display: none;
        }

        @media (max-width: 768px) {
            .data-buttons {
                grid-template-columns: 1fr;
            }

            .export-buttons {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        function AttendanceSystem() {
            const [currentTime, setCurrentTime] = useState(new Date());
            const [status, setStatus] = useState('off'); // off, working, break
            const [todayRecord, setTodayRecord] = useState(null);
            const [allRecords, setAllRecords] = useState([]);
            const [activeTab, setActiveTab] = useState('today');
            const fileInputRef = useRef(null);

            // ç¾åœ¨æ™‚åˆ»ã‚’æ›´æ–°
            useEffect(() => {
                const timer = setInterval(() => {
                    setCurrentTime(new Date());
                }, 1000);
                return () => clearInterval(timer);
            }, []);

            // ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‹ã‚‰è¨˜éŒ²ã‚’èª­ã¿è¾¼ã¿
            useEffect(() => {
                const saved = localStorage.getItem('attendanceRecords');
                if (saved) {
                    const records = JSON.parse(saved);
                    setAllRecords(records);
                    
                    // ä»Šæ—¥ã®è¨˜éŒ²ã‚’æ¢ã™
                    const today = formatDate(new Date());
                    const todayRec = records.find(r => r.date === today);
                    if (todayRec) {
                        setTodayRecord(todayRec);
                        // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’å¾©å…ƒ
                        if (todayRec.endTime) {
                            setStatus('off');
                        } else if (todayRec.breaks && todayRec.breaks[todayRec.breaks.length - 1]?.end === null) {
                            setStatus('break');
                        } else if (todayRec.startTime) {
                            setStatus('working');
                        }
                    }
                }
            }, []);

            // è¨˜éŒ²ã‚’ä¿å­˜
            const saveRecords = (records) => {
                localStorage.setItem('attendanceRecords', JSON.stringify(records));
                setAllRecords(records);
            };

            const formatDate = (date) => {
                const year = date.getFullYear();
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const day = String(date.getDate()).padStart(2, '0');
                return `${year}-${month}-${day}`;
            };

            const formatTime = (date) => {
                const hours = String(date.getHours()).padStart(2, '0');
                const minutes = String(date.getMinutes()).padStart(2, '0');
                return `${hours}:${minutes}`;
            };

            const getDayOfWeek = (date) => {
                const days = ['æ—¥', 'æœˆ', 'ç«', 'æ°´', 'æœ¨', 'é‡‘', 'åœŸ'];
                return days[date.getDay()];
            };

            // å‡ºå‹¤æ‰“åˆ»
            const clockIn = () => {
                const now = new Date();
                const today = formatDate(now);
                const time = formatTime(now);

                const newRecord = {
                    date: today,
                    startTime: time,
                    endTime: null,
                    breaks: [],
                    totalWorkMinutes: 0,
                    totalBreakMinutes: 0
                };

                setTodayRecord(newRecord);
                setStatus('working');

                const updatedRecords = [newRecord, ...allRecords.filter(r => r.date !== today)];
                saveRecords(updatedRecords);
            };

            // é€€å‹¤æ‰“åˆ»
            const clockOut = () => {
                if (!todayRecord) return;

                const now = new Date();
                const time = formatTime(now);

                const updated = {
                    ...todayRecord,
                    endTime: time
                };

                // ä¼‘æ†©ä¸­ã®å ´åˆã¯è‡ªå‹•ã§ä¼‘æ†©çµ‚äº†
                if (status === 'break') {
                    const breaks = [...updated.breaks];
                    breaks[breaks.length - 1].end = time;
                    updated.breaks = breaks;
                }

                // åˆè¨ˆæ™‚é–“ã‚’è¨ˆç®—
                updated.totalWorkMinutes = calculateWorkMinutes(updated);
                updated.totalBreakMinutes = calculateBreakMinutes(updated);

                setTodayRecord(updated);
                setStatus('off');

                const updatedRecords = [updated, ...allRecords.filter(r => r.date !== updated.date)];
                saveRecords(updatedRecords);
            };

            // ä¼‘æ†©é–‹å§‹
            const startBreak = () => {
                if (!todayRecord) return;

                const now = new Date();
                const time = formatTime(now);

                const updated = {
                    ...todayRecord,
                    breaks: [...todayRecord.breaks, { start: time, end: null }]
                };

                setTodayRecord(updated);
                setStatus('break');

                const updatedRecords = [updated, ...allRecords.filter(r => r.date !== updated.date)];
                saveRecords(updatedRecords);
            };

            // ä¼‘æ†©çµ‚äº†
            const endBreak = () => {
                if (!todayRecord || !todayRecord.breaks.length) return;

                const now = new Date();
                const time = formatTime(now);

                const breaks = [...todayRecord.breaks];
                breaks[breaks.length - 1].end = time;

                const updated = {
                    ...todayRecord,
                    breaks
                };

                setTodayRecord(updated);
                setStatus('working');

                const updatedRecords = [updated, ...allRecords.filter(r => r.date !== updated.date)];
                saveRecords(updatedRecords);
            };

            // åŠ´åƒæ™‚é–“ã‚’è¨ˆç®—ï¼ˆåˆ†ï¼‰
            const calculateWorkMinutes = (record) => {
                if (!record.startTime) return 0;

                const start = timeToMinutes(record.startTime);
                const end = record.endTime ? timeToMinutes(record.endTime) : timeToMinutes(formatTime(new Date()));
                
                let totalWork = end - start;
                
                // ä¼‘æ†©æ™‚é–“ã‚’å¼•ã
                const breakTime = calculateBreakMinutes(record);
                totalWork -= breakTime;

                return Math.max(0, totalWork);
            };

            // ä¼‘æ†©æ™‚é–“ã‚’è¨ˆç®—ï¼ˆåˆ†ï¼‰
            const calculateBreakMinutes = (record) => {
                if (!record.breaks || record.breaks.length === 0) return 0;

                let total = 0;
                record.breaks.forEach(b => {
                    if (b.start && b.end) {
                        const start = timeToMinutes(b.start);
                        const end = timeToMinutes(b.end);
                        total += (end - start);
                    }
                });

                return total;
            };

            // æ™‚åˆ»ã‚’åˆ†ã«å¤‰æ›
            const timeToMinutes = (timeStr) => {
                const [hours, minutes] = timeStr.split(':').map(Number);
                return hours * 60 + minutes;
            };

            // åˆ†ã‚’æ™‚é–“è¡¨è¨˜ã«å¤‰æ›
            const minutesToHours = (minutes) => {
                const hours = Math.floor(minutes / 60);
                const mins = minutes % 60;
                return `${hours}æ™‚é–“${mins}åˆ†`;
            };

            // ä»Šæœˆã®çµ±è¨ˆã‚’è¨ˆç®—
            const getMonthlyStats = () => {
                const now = new Date();
                const year = now.getFullYear();
                const month = now.getMonth();

                const monthRecords = allRecords.filter(r => {
                    const recordDate = new Date(r.date);
                    return recordDate.getFullYear() === year && recordDate.getMonth() === month;
                });

                const totalMinutes = monthRecords.reduce((sum, r) => sum + (r.totalWorkMinutes || 0), 0);
                const workDays = monthRecords.filter(r => r.endTime).length;
                const avgMinutes = workDays > 0 ? Math.floor(totalMinutes / workDays) : 0;

                return {
                    totalMinutes,
                    workDays,
                    avgMinutes
                };
            };

            const monthlyStats = getMonthlyStats();

            // æ™‚é–“å¤–åŠ´åƒã®è­¦å‘Šãƒã‚§ãƒƒã‚¯
            const checkOvertime = () => {
                if (!todayRecord) return null;
                
                const workMinutes = calculateWorkMinutes(todayRecord);
                const workHours = workMinutes / 60;

                if (workHours > 8) {
                    return `æœ¬æ—¥ã®åŠ´åƒæ™‚é–“ãŒ8æ™‚é–“ã‚’è¶…ãˆã¦ã„ã¾ã™ï¼ˆ${minutesToHours(workMinutes)}ï¼‰`;
                }

                // æœˆã®æ™‚é–“å¤–ã‚’ãƒã‚§ãƒƒã‚¯
                const monthlyHours = monthlyStats.totalMinutes / 60;
                if (monthlyHours > 160) { // æœˆ40æ™‚é–“ Ã— 4é€± = 160æ™‚é–“ã®åŸºæº–åŠ´åƒæ™‚é–“
                    const overtime = monthlyHours - 160;
                    if (overtime > 45) {
                        return `ä»Šæœˆã®æ™‚é–“å¤–åŠ´åƒãŒ45æ™‚é–“ã‚’è¶…ãˆã‚‹è¦‹è¾¼ã¿ã§ã™`;
                    }
                }

                return null;
            };

            const warning = checkOvertime();

            // ãƒ‡ãƒ¼ã‚¿ã‚’JSONå½¢å¼ã§ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ
            const exportData = () => {
                const dataStr = JSON.stringify(allRecords, null, 2);
                const dataBlob = new Blob([dataStr], { type: 'application/json' });
                const url = URL.createObjectURL(dataBlob);
                const link = document.createElement('a');
                link.href = url;
                link.download = `å‹¤æ€ è¨˜éŒ²_${formatDate(new Date())}.json`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(url);
                alert('JSONãƒ‡ãƒ¼ã‚¿ã‚’ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã—ã¾ã—ãŸ');
            };

            // ãƒ‡ãƒ¼ã‚¿ã‚’CSVå½¢å¼ã§ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆï¼ˆExcelç”¨ï¼‰
            const exportCSV = () => {
                if (allRecords.length === 0) {
                    alert('ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã™ã‚‹ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“');
                    return;
                }

                // CSVãƒ˜ãƒƒãƒ€ãƒ¼
                let csv = '\uFEFF'; // BOMï¼ˆUTF-8ã§Excelã§æ­£ã—ãé–‹ããŸã‚ã«å¿…è¦ï¼‰
                csv += 'æ—¥ä»˜,æ›œæ—¥,å‡ºå‹¤æ™‚åˆ»,é€€å‹¤æ™‚åˆ»,åŠ´åƒæ™‚é–“ï¼ˆæ™‚é–“ï¼‰,åŠ´åƒæ™‚é–“ï¼ˆåˆ†ï¼‰,ä¼‘æ†©æ™‚é–“ï¼ˆæ™‚é–“ï¼‰,ä¼‘æ†©æ™‚é–“ï¼ˆåˆ†ï¼‰,ä¼‘æ†©å›æ•°,å‚™è€ƒ\n';

                // ãƒ‡ãƒ¼ã‚¿è¡Œã‚’è¿½åŠ 
                allRecords.forEach(record => {
                    const date = new Date(record.date);
                    const dayOfWeek = getDayOfWeek(date);
                    const workMinutes = record.totalWorkMinutes || calculateWorkMinutes(record);
                    const breakMinutes = record.totalBreakMinutes || calculateBreakMinutes(record);
                    const workHours = Math.floor(workMinutes / 60);
                    const workMins = workMinutes % 60;
                    const breakHours = Math.floor(breakMinutes / 60);
                    const breakMins = breakMinutes % 60;
                    
                    // ä¼‘æ†©å›æ•°
                    const breakCount = record.breaks ? record.breaks.length : 0;
                    
                    // å‚™è€ƒï¼ˆä¼‘æ†©ã®è©³ç´°ï¼‰
                    let notes = '';
                    if (record.breaks && record.breaks.length > 0) {
                        notes = record.breaks.map((b, i) => 
                            `ä¼‘æ†©${i + 1}: ${b.start}-${b.end || 'æœªçµ‚äº†'}`
                        ).join('; ');
                    }
                    
                    csv += `${record.date},${dayOfWeek},${record.startTime || ''},${record.endTime || ''},`;
                    csv += `${workHours},${workMins},${breakHours},${breakMins},${breakCount},"${notes}"\n`;
                });

                // ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
                const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                link.download = `å‹¤æ€ è¨˜éŒ²_${formatDate(new Date())}.csv`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(url);
                alert('CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã—ã¾ã—ãŸ\nExcelã§é–‹ãã“ã¨ãŒã§ãã¾ã™');
            };

            // ãƒ‡ãƒ¼ã‚¿ã‚’Excelç”¨ã®è©³ç´°CSVå½¢å¼ã§ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ
            const exportDetailedCSV = () => {
                if (allRecords.length === 0) {
                    alert('ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã™ã‚‹ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“');
                    return;
                }

                // CSVãƒ˜ãƒƒãƒ€ãƒ¼
                let csv = '\uFEFF'; // BOM
                csv += 'æ—¥ä»˜,æ›œæ—¥,å‡ºå‹¤æ™‚åˆ»,é€€å‹¤æ™‚åˆ»,ç·åŠ´åƒæ™‚é–“,ä¼‘æ†©æ™‚é–“,å®ŸåŠ´åƒæ™‚é–“,æ™‚é–“å¤–åŠ´åƒ,æ·±å¤œåŠ´åƒ,ä¼‘æ—¥åŠ´åƒ\n';

                // æœˆæ¬¡ã‚µãƒãƒªãƒ¼ç”¨ã®ãƒ‡ãƒ¼ã‚¿
                const monthlyData = {};

                allRecords.forEach(record => {
                    const date = new Date(record.date);
                    const dayOfWeek = getDayOfWeek(date);
                    const workMinutes = record.totalWorkMinutes || calculateWorkMinutes(record);
                    const breakMinutes = record.totalBreakMinutes || calculateBreakMinutes(record);
                    
                    // ç·åŠ´åƒæ™‚é–“ï¼ˆä¼‘æ†©å«ã‚€ï¼‰
                    const totalMinutes = workMinutes + breakMinutes;
                    
                    // æ™‚é–“å¤–åŠ´åƒï¼ˆ8æ™‚é–“è¶…éåˆ†ï¼‰
                    const overtimeMinutes = Math.max(0, workMinutes - 480);
                    
                    // æœˆæ¬¡ãƒ‡ãƒ¼ã‚¿ã®é›†è¨ˆ
                    const yearMonth = record.date.substring(0, 7);
                    if (!monthlyData[yearMonth]) {
                        monthlyData[yearMonth] = {
                            workDays: 0,
                            totalWork: 0,
                            totalOvertime: 0
                        };
                    }
                    if (record.endTime) {
                        monthlyData[yearMonth].workDays++;
                        monthlyData[yearMonth].totalWork += workMinutes;
                        monthlyData[yearMonth].totalOvertime += overtimeMinutes;
                    }
                    
                    // ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆé–¢æ•°
                    const formatMinutes = (mins) => {
                        const h = Math.floor(mins / 60);
                        const m = mins % 60;
                        return `${h}:${String(m).padStart(2, '0')}`;
                    };
                    
                    csv += `${record.date},${dayOfWeek},${record.startTime || ''},${record.endTime || ''},`;
                    csv += `${formatMinutes(totalMinutes)},${formatMinutes(breakMinutes)},`;
                    csv += `${formatMinutes(workMinutes)},${formatMinutes(overtimeMinutes)},0:00,0:00\n`;
                });

                // æœˆæ¬¡ã‚µãƒãƒªãƒ¼ã‚’è¿½åŠ 
                csv += '\næœˆæ¬¡ã‚µãƒãƒªãƒ¼\n';
                csv += 'å¹´æœˆ,å‡ºå‹¤æ—¥æ•°,ç·åŠ´åƒæ™‚é–“,æ™‚é–“å¤–åŠ´åƒ,å¹³å‡åŠ´åƒæ™‚é–“\n';
                
                Object.keys(monthlyData).sort().reverse().forEach(yearMonth => {
                    const data = monthlyData[yearMonth];
                    const avgMinutes = data.workDays > 0 ? Math.floor(data.totalWork / data.workDays) : 0;
                    
                    const formatMinutes = (mins) => {
                        const h = Math.floor(mins / 60);
                        const m = mins % 60;
                        return `${h}:${String(m).padStart(2, '0')}`;
                    };
                    
                    csv += `${yearMonth},${data.workDays},${formatMinutes(data.totalWork)},`;
                    csv += `${formatMinutes(data.totalOvertime)},${formatMinutes(avgMinutes)}\n`;
                });

                // ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
                const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                link.download = `å‹¤æ€ è¨˜éŒ²_è©³ç´°_${formatDate(new Date())}.csv`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(url);
                alert('è©³ç´°CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã—ã¾ã—ãŸ\næœˆæ¬¡ã‚µãƒãƒªãƒ¼ä»˜ãã§Excelã§é–‹ã‘ã¾ã™');
            };

            // ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆï¼ˆJSONãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰èª­ã¿è¾¼ã¿ï¼‰
            const importData = (event) => {
                const file = event.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const importedRecords = JSON.parse(e.target.result);
                        
                        // ãƒ‡ãƒ¼ã‚¿ã®å¦¥å½“æ€§ãƒã‚§ãƒƒã‚¯
                        if (!Array.isArray(importedRecords)) {
                            alert('ç„¡åŠ¹ãªãƒ‡ãƒ¼ã‚¿å½¢å¼ã§ã™');
                            return;
                        }

                        // ç¢ºèªãƒ€ã‚¤ã‚¢ãƒ­ã‚°
                        const confirm = window.confirm(
                            `${importedRecords.length}ä»¶ã®è¨˜éŒ²ã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆã—ã¾ã™ã€‚\næ—¢å­˜ã®ãƒ‡ãƒ¼ã‚¿ã¯ä¸Šæ›¸ãã•ã‚Œã¾ã™ã€‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ`
                        );

                        if (confirm) {
                            saveRecords(importedRecords);
                            
                            // ä»Šæ—¥ã®è¨˜éŒ²ã‚’æ›´æ–°
                            const today = formatDate(new Date());
                            const todayRec = importedRecords.find(r => r.date === today);
                            setTodayRecord(todayRec || null);
                            
                            // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’æ›´æ–°
                            if (todayRec) {
                                if (todayRec.endTime) {
                                    setStatus('off');
                                } else if (todayRec.breaks && todayRec.breaks[todayRec.breaks.length - 1]?.end === null) {
                                    setStatus('break');
                                } else if (todayRec.startTime) {
                                    setStatus('working');
                                }
                            } else {
                                setStatus('off');
                            }

                            alert('ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆã—ã¾ã—ãŸ');
                        }
                    } catch (error) {
                        alert('ãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
                    }
                };
                reader.readAsText(file);
                
                // ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠã‚’ãƒªã‚»ãƒƒãƒˆ
                event.target.value = '';
            };

            // ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¯ãƒªã‚¢
            const clearData = () => {
                const confirm = window.confirm(
                    'ã™ã¹ã¦ã®å‹¤æ€ è¨˜éŒ²ã‚’å‰Šé™¤ã—ã¾ã™ã€‚\nã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“ã€‚æœ¬å½“ã«ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ'
                );

                if (confirm) {
                    const doubleConfirm = window.confirm(
                        'æœ¬å½“ã«å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ\nãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚’å–ã£ã¦ã„ãªã„å ´åˆã€ãƒ‡ãƒ¼ã‚¿ã¯å¾©å…ƒã§ãã¾ã›ã‚“ã€‚'
                    );

                    if (doubleConfirm) {
                        localStorage.removeItem('attendanceRecords');
                        setAllRecords([]);
                        setTodayRecord(null);
                        setStatus('off');
                        alert('ã™ã¹ã¦ã®ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ã¾ã—ãŸ');
                    }
                }
            };

            // ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã‚’é–‹ã
            const triggerFileInput = () => {
                fileInputRef.current?.click();
            };

            // ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã®ä½¿ç”¨çŠ¶æ³ã‚’å–å¾—
            const getStorageInfo = () => {
                const dataStr = JSON.stringify(allRecords);
                const bytes = new Blob([dataStr]).size;
                const kb = (bytes / 1024).toFixed(2);
                return {
                    records: allRecords.length,
                    size: kb
                };
            };

            const storageInfo = getStorageInfo();

            return (
                <div className="container">
                    <div className="header">
                        <h1>å‹¤æ€ ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ </h1>
                        <div className="user-info">
                            è¥¿æ—¥æœ¬é«˜é€Ÿé“è·¯ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹é–¢è¥¿æ ªå¼ä¼šç¤¾
                        </div>
                    </div>

                    <div className="clock-section">
                        <div className="current-time">
                            <div className="date">
                                {currentTime.getFullYear()}å¹´{currentTime.getMonth() + 1}æœˆ{currentTime.getDate()}æ—¥ï¼ˆ{getDayOfWeek(currentTime)}ï¼‰
                            </div>
                            <div className="time">
                                {formatTime(currentTime)}
                            </div>
                        </div>

                        <div className="clock-buttons">
                            <button 
                                className="clock-btn start"
                                onClick={clockIn}
                                disabled={status !== 'off'}
                            >
                                å‡ºå‹¤
                            </button>
                            <button 
                                className="clock-btn end"
                                onClick={clockOut}
                                disabled={status === 'off'}
                            >
                                é€€å‹¤
                            </button>
                            <button 
                                className="clock-btn break-start"
                                onClick={startBreak}
                                disabled={status !== 'working'}
                            >
                                ä¼‘æ†©é–‹å§‹
                            </button>
                            <button 
                                className="clock-btn break-end"
                                onClick={endBreak}
                                disabled={status !== 'break'}
                            >
                                ä¼‘æ†©çµ‚äº†
                            </button>
                        </div>

                        <div className="status-display">
                            <div className="label">ç¾åœ¨ã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</div>
                            <div className="value">
                                {status === 'working' && 'å‹¤å‹™ä¸­'}
                                {status === 'break' && 'ä¼‘æ†©ä¸­'}
                                {status === 'off' && 'é€€å‹¤æ¸ˆã¿ / å‹¤å‹™å‰'}
                            </div>
                            <div className={`status-badge ${status}`}>
                                {status === 'working' && 'ğŸŸ¢ å‹¤å‹™ä¸­'}
                                {status === 'break' && 'ğŸŸ¡ ä¼‘æ†©ä¸­'}
                                {status === 'off' && 'âšª ã‚ªãƒ•'}
                            </div>
                        </div>

                        {warning && (
                            <div className="warning">
                                <div className="warning-text">âš ï¸ {warning}</div>
                            </div>
                        )}
                    </div>

                    <div className="grid-2">
                        <div className="card">
                            <h2>æœ¬æ—¥ã®å‹¤å‹™</h2>
                            {todayRecord ? (
                                <>
                                    <div className="stat-grid">
                                        <div className="stat-item">
                                            <div className="label">å‡ºå‹¤æ™‚åˆ»</div>
                                            <div className="value">{todayRecord.startTime || '--:--'}</div>
                                        </div>
                                        <div className="stat-item">
                                            <div className="label">é€€å‹¤æ™‚åˆ»</div>
                                            <div className="value">{todayRecord.endTime || '--:--'}</div>
                                        </div>
                                        <div className="stat-item">
                                            <div className="label">åŠ´åƒæ™‚é–“</div>
                                            <div className="value">
                                                {Math.floor(calculateWorkMinutes(todayRecord) / 60)}
                                                <span className="unit">æ™‚é–“</span>
                                                {calculateWorkMinutes(todayRecord) % 60}
                                                <span className="unit">åˆ†</span>
                                            </div>
                                        </div>
                                        <div className="stat-item">
                                            <div className="label">ä¼‘æ†©æ™‚é–“</div>
                                            <div className="value">
                                                {Math.floor(calculateBreakMinutes(todayRecord) / 60)}
                                                <span className="unit">æ™‚é–“</span>
                                                {calculateBreakMinutes(todayRecord) % 60}
                                                <span className="unit">åˆ†</span>
                                            </div>
                                        </div>
                                    </div>

                                    {todayRecord.breaks && todayRecord.breaks.length > 0 && (
                                        <div style={{ marginTop: '16px', fontSize: '13px', color: '#64748B' }}>
                                            <div style={{ marginBottom: '8px', fontWeight: '600' }}>ä¼‘æ†©è¨˜éŒ²</div>
                                            {todayRecord.breaks.map((b, i) => (
                                                <div key={i} style={{ padding: '4px 0' }}>
                                                    ä¼‘æ†©{i + 1}: {b.start} - {b.end || 'ï¼ˆä¼‘æ†©ä¸­ï¼‰'}
                                                </div>
                                            ))}
                                        </div>
                                    )}
                                </>
                            ) : (
                                <div className="empty-state">
                                    å‡ºå‹¤æ‰“åˆ»ã‚’ã—ã¦ãã ã•ã„
                                </div>
                            )}
                        </div>

                        <div className="card">
                            <h2>ä»Šæœˆã®çµ±è¨ˆ</h2>
                            <div className="stat-grid">
                                <div className="stat-item">
                                    <div className="label">å‡ºå‹¤æ—¥æ•°</div>
                                    <div className="value">
                                        {monthlyStats.workDays}
                                        <span className="unit">æ—¥</span>
                                    </div>
                                </div>
                                <div className="stat-item">
                                    <div className="label">ç·åŠ´åƒæ™‚é–“</div>
                                    <div className="value">
                                        {Math.floor(monthlyStats.totalMinutes / 60)}
                                        <span className="unit">æ™‚é–“</span>
                                    </div>
                                </div>
                                <div className="stat-item">
                                    <div className="label">å¹³å‡åŠ´åƒæ™‚é–“</div>
                                    <div className="value">
                                        {Math.floor(monthlyStats.avgMinutes / 60)}
                                        <span className="unit">æ™‚é–“</span>
                                        {monthlyStats.avgMinutes % 60}
                                        <span className="unit">åˆ†</span>
                                    </div>
                                </div>
                                <div className="stat-item">
                                    <div className="label">æ™‚é–“å¤–åŠ´åƒ</div>
                                    <div className="value">
                                        {Math.max(0, Math.floor((monthlyStats.totalMinutes - 160 * 60) / 60))}
                                        <span className="unit">æ™‚é–“</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div className="card">
                        <h2>å‹¤å‹™è¨˜éŒ²</h2>
                        <div className="tabs">
                            <button 
                                className={`tab ${activeTab === 'today' ? 'active' : ''}`}
                                onClick={() => setActiveTab('today')}
                            >
                                ä»Šæ—¥
                            </button>
                            <button 
                                className={`tab ${activeTab === 'week' ? 'active' : ''}`}
                                onClick={() => setActiveTab('week')}
                            >
                                ä»Šé€±
                            </button>
                            <button 
                                className={`tab ${activeTab === 'month' ? 'active' : ''}`}
                                onClick={() => setActiveTab('month')}
                            >
                                ä»Šæœˆ
                            </button>
                        </div>

                        <div className="record-list">
                            {(() => {
                                const now = new Date();
                                let filteredRecords = [];

                                if (activeTab === 'today') {
                                    filteredRecords = allRecords.filter(r => r.date === formatDate(now));
                                } else if (activeTab === 'week') {
                                    const weekAgo = new Date(now);
                                    weekAgo.setDate(weekAgo.getDate() - 7);
                                    filteredRecords = allRecords.filter(r => new Date(r.date) >= weekAgo);
                                } else {
                                    const year = now.getFullYear();
                                    const month = now.getMonth();
                                    filteredRecords = allRecords.filter(r => {
                                        const recordDate = new Date(r.date);
                                        return recordDate.getFullYear() === year && recordDate.getMonth() === month;
                                    });
                                }

                                if (filteredRecords.length === 0) {
                                    return <div className="empty-state">è¨˜éŒ²ãŒã‚ã‚Šã¾ã›ã‚“</div>;
                                }

                                return filteredRecords.map(record => (
                                    <div key={record.date} className="record-item">
                                        <div className="record-date">
                                            {record.date} ({getDayOfWeek(new Date(record.date))})
                                        </div>
                                        <div className="record-details">
                                            <div className="record-time">
                                                ğŸ• {record.startTime} - {record.endTime || 'å‹¤å‹™ä¸­'}
                                            </div>
                                            <div className="record-total">
                                                {minutesToHours(record.totalWorkMinutes || calculateWorkMinutes(record))}
                                            </div>
                                        </div>
                                    </div>
                                ));
                            })()}
                        </div>
                    </div>

                    <div className="card">
                        <h2>ãƒ‡ãƒ¼ã‚¿ç®¡ç†</h2>
                        
                        <div className="data-management">
                            <h3>ğŸ“Š ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆï¼ˆãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ï¼‰</h3>
                            
                            <div className="export-buttons">
                                <button className="data-btn export" onClick={exportCSV}>
                                    ğŸ“Š CSV (Excelç”¨)
                                </button>
                                <button className="data-btn export" onClick={exportDetailedCSV}>
                                    ğŸ“ˆ è©³ç´°CSV (æœˆæ¬¡ä»˜)
                                </button>
                            </div>

                            <h3 style={{ marginTop: '16px' }}>ğŸ’¾ ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ãƒ»å¾©å…ƒ</h3>
                            
                            <div className="data-buttons">
                                <button className="data-btn export" onClick={exportData}>
                                    ğŸ“¥ JSONã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ
                                </button>
                                <button className="data-btn import" onClick={triggerFileInput}>
                                    ğŸ“¤ ã‚¤ãƒ³ãƒãƒ¼ãƒˆ
                                </button>
                            </div>

                            <h3 style={{ marginTop: '16px' }}>ğŸ—‘ï¸ ãƒ‡ãƒ¼ã‚¿å‰Šé™¤</h3>
                            
                            <button 
                                className="data-btn clear" 
                                onClick={clearData}
                                style={{ width: '100%' }}
                            >
                                ã™ã¹ã¦ã®ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤
                            </button>

                            <input
                                ref={fileInputRef}
                                type="file"
                                accept=".json"
                                onChange={importData}
                            />

                            <div className="storage-info">
                                <div style={{ marginBottom: '8px' }}>
                                    <strong>ä¿å­˜çŠ¶æ³:</strong> {storageInfo.records}ä»¶ã®è¨˜éŒ² ({storageInfo.size} KB)
                                </div>
                                <div style={{ fontSize: '12px', lineHeight: '1.6' }}>
                                    â„¹ï¸ <strong>ãƒ‡ãƒ¼ã‚¿ã¯ãƒ–ãƒ©ã‚¦ã‚¶å†…ã«ä¿å­˜ã•ã‚Œã¦ã„ã¾ã™</strong><br/>
                                    <br/>
                                    ğŸ“Š <strong>CSV (Excelç”¨)</strong>: Excelã§é–‹ã‘ã‚‹åŸºæœ¬çš„ãªå‹¤æ€ ãƒ‡ãƒ¼ã‚¿<br/>
                                    ğŸ“ˆ <strong>è©³ç´°CSV</strong>: æ™‚é–“å¤–åŠ´åƒè¨ˆç®—ã¨æœˆæ¬¡ã‚µãƒãƒªãƒ¼ä»˜ã<br/>
                                    ğŸ“¥ <strong>JSONã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ</strong>: ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ç”¨ï¼ˆã‚¤ãƒ³ãƒãƒ¼ãƒˆå¯èƒ½ï¼‰<br/>
                                    ğŸ“¤ <strong>ã‚¤ãƒ³ãƒãƒ¼ãƒˆ</strong>: JSONãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ã‚’å¾©å…ƒ<br/>
                                    ğŸ—‘ï¸ <strong>ãƒ‡ãƒ¼ã‚¿å‰Šé™¤</strong>: ã™ã¹ã¦ã®è¨˜éŒ²ã‚’å®Œå…¨ã«å‰Šé™¤
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            );
        }

        ReactDOM.render(<AttendanceSystem />, document.getElementById('root'));
    </script>
</body>
</html>
